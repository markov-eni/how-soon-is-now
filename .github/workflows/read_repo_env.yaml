name: Debug TF Env Variables

on:
  push:
    branches: [ main ]

jobs:
  load_and_debug_env_vars:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read .github_tf_env and load repo variables
        env:
          GH_TOKEN: ${{ secrets.READ_REPO_VARS }} # github pat repo scoped with variables read 
          REPO: ${{ github.repository }}
        run: |
          echo "Reading .github_tf_env file..."
          if [ ! -f ".github_tf_env" ]; then
            echo ".github_tf_env file not found!"
            exit 1
          fi

          echo "Loading variables..."
          while read -r VAR_NAME; do
            if [ -z "$VAR_NAME" ]; then
              continue
            fi

            # Fetch the variable value from GitHub repository variables
            VALUE=$(gh api repos/$REPO/actions/variables/$VAR_NAME --jq '.value' 2>/dev/null || echo "<NOT FOUND>")

            echo "Variable: $VAR_NAME"
            echo "Value: $VALUE"
            echo "$VAR_NAME=$VALUE" >> $GITHUB_ENV
          done < .github_tf_env

      - name: Print loaded environment variables
        run: |
          echo "Loaded variables:"
          cat $GITHUB_ENV

      - run: echo $TF_VAR_IMAGE_NAME
